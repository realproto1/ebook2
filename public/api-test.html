<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API í…ŒìŠ¤íŠ¸ í˜ì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">ğŸ” API ë””ë²„ê¹… ë„êµ¬</h1>
        
        <!-- í™˜ê²½ ë³€ìˆ˜ ì²´í¬ -->
        <div class="mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-3">1. í™˜ê²½ ë³€ìˆ˜ ìƒíƒœ í™•ì¸</h2>
            <button 
                onclick="checkEnv()"
                class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-semibold"
            >
                í™˜ê²½ ë³€ìˆ˜ í™•ì¸
            </button>
            <div id="envStatus" class="mt-4"></div>
        </div>

        <hr class="my-6">
        
        <!-- API ì—°ê²° í…ŒìŠ¤íŠ¸ -->
        <div class="mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-3">2. API ì—°ê²° í…ŒìŠ¤íŠ¸</h2>
            <button 
                onclick="testAPI()"
                class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold"
            >
                ë™í™”ì±… ìƒì„± API í…ŒìŠ¤íŠ¸
            </button>
            <div id="apiStatus" class="mt-4"></div>
        </div>
        
        <div id="details" class="mt-6 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-3">ìƒì„¸ ì •ë³´:</h2>
            <pre id="response" class="bg-gray-100 p-4 rounded-lg overflow-auto text-sm max-h-96"></pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script>
        async function checkEnv() {
            const envStatusDiv = document.getElementById('envStatus');
            const detailsDiv = document.getElementById('details');
            const responseDiv = document.getElementById('response');
            
            envStatusDiv.innerHTML = '<p class="text-blue-600">í™•ì¸ ì¤‘...</p>';
            
            try {
                const response = await axios.get('/api/debug/env');
                const data = response.data;
                
                const statusColor = data.hasAPIKey ? 'green' : 'red';
                const statusIcon = data.hasAPIKey ? 'âœ…' : 'âŒ';
                
                envStatusDiv.innerHTML = `
                    <div class="p-4 rounded-lg bg-${statusColor}-50 border-2 border-${statusColor}-200">
                        <p class="text-${statusColor}-600 font-bold text-lg">${statusIcon} ${data.message}</p>
                        <div class="mt-3 text-sm text-gray-700">
                            <p><strong>í™˜ê²½:</strong> ${data.environment}</p>
                            <p><strong>API í‚¤ ê¸¸ì´:</strong> ${data.keyLength} ë¬¸ì</p>
                            <p><strong>API í‚¤ ë¯¸ë¦¬ë³´ê¸°:</strong> ${data.keyPreview}</p>
                            ${data.allEnvKeys.length > 0 ? 
                                `<p><strong>ê´€ë ¨ í™˜ê²½ ë³€ìˆ˜:</strong> ${data.allEnvKeys.join(', ')}</p>` : 
                                '<p class="text-red-600 mt-2"><strong>âš ï¸ GEMINI ê´€ë ¨ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!</strong></p>'
                            }
                        </div>
                    </div>
                `;
                
                detailsDiv.classList.remove('hidden');
                responseDiv.textContent = JSON.stringify(data, null, 2);
                
            } catch (error) {
                console.error('Env Check Error:', error);
                envStatusDiv.innerHTML = `
                    <div class="p-4 rounded-lg bg-red-50 border-2 border-red-200">
                        <p class="text-red-600 font-bold">âŒ í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ì‹¤íŒ¨</p>
                        <p class="text-sm text-gray-600 mt-2">${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function testAPI() {
            const apiStatusDiv = document.getElementById('apiStatus');
            const detailsDiv = document.getElementById('details');
            const responseDiv = document.getElementById('response');
            
            apiStatusDiv.innerHTML = '<p class="text-blue-600">í…ŒìŠ¤íŠ¸ ì¤‘...</p>';
            
            try {
                const response = await axios.post('/api/generate-storybook', {
                    title: 'API í…ŒìŠ¤íŠ¸',
                    targetAge: '5-7',
                    artStyle: 'Modern Illustration'
                });
                
                apiStatusDiv.innerHTML = `
                    <div class="p-4 rounded-lg bg-green-50 border-2 border-green-200">
                        <p class="text-green-600 font-bold text-lg">âœ… ì„±ê³µ! APIê°€ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.</p>
                        <p class="text-sm text-gray-600 mt-2">ë™í™”ì±…ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                
                detailsDiv.classList.remove('hidden');
                responseDiv.textContent = JSON.stringify(response.data, null, 2);
                
            } catch (error) {
                console.error('API Error:', error);
                
                const errorMsg = error.response?.data?.error || error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                const statusCode = error.response?.status || 'ì—†ìŒ';
                
                apiStatusDiv.innerHTML = `
                    <div class="p-4 rounded-lg bg-red-50 border-2 border-red-200">
                        <p class="text-red-600 font-bold text-lg">âŒ ì‹¤íŒ¨: API ì˜¤ë¥˜</p>
                        <p class="text-sm text-gray-700 mt-2"><strong>ìƒíƒœ ì½”ë“œ:</strong> ${statusCode}</p>
                        <p class="text-sm text-gray-700 mt-1"><strong>ì˜¤ë¥˜ ë©”ì‹œì§€:</strong></p>
                        <p class="text-sm text-gray-600 mt-1 whitespace-pre-wrap">${errorMsg}</p>
                        
                        ${statusCode === 403 ? `
                            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                                <p class="text-yellow-800 font-semibold">ğŸ’¡ 403 ì—ëŸ¬ í•´ê²° ë°©ë²•:</p>
                                <ol class="text-sm text-yellow-700 mt-2 ml-4 list-decimal">
                                    <li>Vercel Dashboard â†’ Settings â†’ Environment Variables</li>
                                    <li>GEMINI_API_KEY í™•ì¸ (ëŒ€ì†Œë¬¸ì ì •í™•íˆ)</li>
                                    <li>Production, Preview, Development ëª¨ë‘ ì²´í¬</li>
                                    <li>Save í›„ Deployments â†’ Redeploy</li>
                                </ol>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                detailsDiv.classList.remove('hidden');
                responseDiv.textContent = JSON.stringify({
                    status: statusCode,
                    error: errorMsg,
                    fullError: error.response?.data || error.message
                }, null, 2);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ í™˜ê²½ ë³€ìˆ˜ í™•ì¸
        window.addEventListener('DOMContentLoaded', () => {
            checkEnv();
        });
    </script>
</body>
</html>
